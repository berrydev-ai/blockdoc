!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("ajv"),require("ajv-formats"),require("fs"),require("path"),require("url"),require("marked"),require("highlight.js")):"function"==typeof define&&define.amd?define(["exports","ajv","ajv-formats","fs","path","url","marked","highlight.js"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BlockDoc={},t.Ajv,t.AjvFormats,t.fs,t.path,t.url,t.marked,t.hljs)}(this,(function(t,e,r,n,i,o,c,a){"use strict";var s="undefined"!=typeof document?document.currentScript:null;const l=["text","heading","image","code","list","quote","embed","divider"],u={heading:["level"],code:["language"],image:["url","alt"],list:["items","listType"]};class d{constructor(t){if(!t.id)throw new Error("Block ID is required");if(!t.type||!l.includes(t.type))throw new Error(`Invalid block type: ${t.type}. Allowed types are: ${l.join(", ")}`);this.id=t.id,this.type=t.type,this.content=t.content||"";const e=u[this.type]||[];for(const r of e){if(void 0===t[r])throw new Error(`Block of type "${this.type}" requires property "${r}"`);this[r]=t[r]}Object.keys(t).forEach((e=>{["id","type","content"].includes(e)||void 0!==this[e]||(this[e]=t[e])}))}update(t){const{id:e,type:r,...n}=t;return Object.keys(n).forEach((t=>{this[t]=n[t]})),this}toJSON(){const t={id:this.id,type:this.type,content:this.content};return Object.keys(this).forEach((e=>{["id","type","content"].includes(e)||(t[e]=this[e])})),t}static text(t,e){return new d({id:t,type:"text",content:e})}static heading(t,e,r){return new d({id:t,type:"heading",level:e,content:r})}static image(t,e,r,n){return new d({id:t,type:"image",content:"",url:e,alt:r,...n?{caption:n}:{}})}static code(t,e,r){return new d({id:t,type:"code",language:e,content:r})}static list(t,e){return new d({id:t,type:"list",content:"",items:e,listType:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unordered"})}}const h=i.dirname(o.fileURLToPath("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:s&&"SCRIPT"===s.tagName.toUpperCase()&&s.src||new URL("blockdoc.min.js",document.baseURI).href)),p=i.join(h,"schema/blockdoc.schema.json"),f=n.readFileSync(p,"utf-8"),k=JSON.parse(f);function m(t){if(!t)return"";const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return String(t).replace(/[&<>"']/g,(function(t){return e[t]}))}function b(t){if(!t||!t.blocks||!Array.isArray(t.blocks))throw new Error("Invalid article structure");const e=['<article class="blockdoc-article">',`<h1 class="blockdoc-title">${m(t.title)}</h1>`];return t.blocks.forEach((t=>{e.push(function(t){const{id:e,type:r}=t,n=`<div class="blockdoc-block blockdoc-${r}" data-block-id="${e}" data-block-type="${r}">`,i="</div>";let o;switch(r){case"text":o=function(t){return c.marked.parse(t.content)}(t);break;case"heading":o=function(t){const{level:e,content:r}=t,n=Math.min(Math.max(parseInt(e)||2,1),6);return`<h${n}>${m(r)}</h${n}>`}(t);break;case"image":o=function(t){const{url:e,alt:r,caption:n}=t;let i=`<img src="${m(e)}" alt="${m(r)}" class="blockdoc-image" />`;if(n)return i+=`<figcaption class="blockdoc-caption">${m(n)}</figcaption>`,`<figure class="blockdoc-figure">${i}</figure>`;return i}(t);break;case"code":o=function(t){const{language:e,content:r}=t;let n;try{n=e&&a.getLanguage(e)?a.highlight(r,{language:e}).value:a.highlightAuto(r).value}catch(t){n=m(r)}return`\n    <pre class="blockdoc-pre">\n      <code class="blockdoc-code ${e?`language-${e}`:""}">${n}</code>\n    </pre>\n  `}(t);break;case"list":o=function(t){const{items:e,listType:r}=t;if(!e||!Array.isArray(e))return"<p>Invalid list items</p>";const n="ordered"===r?"ol":"ul",i=e.map((t=>`<li>${c.marked.parse(t)}</li>`)).join("");return`<${n} class="blockdoc-list blockdoc-list-${r}">${i}</${n}>`}(t);break;case"quote":o=function(t){const{content:e,attribution:r}=t;let n=`<blockquote class="blockdoc-quote">${c.marked.parse(e)}</blockquote>`;r&&(n+=`<cite class="blockdoc-attribution">${m(r)}</cite>`);return n}(t);break;case"embed":o=function(t){const{url:e,caption:r,embedType:n}=t;let i;if("youtube"===n){const t=function(t){try{const e=new URL(t);if("youtu.be"===e.hostname)return e.pathname.slice(1);if("www.youtube.com"===e.hostname||"youtube.com"===e.hostname){return new URLSearchParams(e.search).get("v")}return null}catch(t){return null}}(e);i=t?`\n        <div class="blockdoc-embed-container">\n          <iframe \n            width="560" \n            height="315" \n            src="https://www.youtube.com/embed/${t}" \n            frameborder="0" \n            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" \n            allowfullscreen>\n          </iframe>\n        </div>\n      `:"<p>Invalid YouTube URL</p>"}else i="twitter"===n?`\n      <div class="blockdoc-embed blockdoc-twitter">\n        <blockquote class="twitter-tweet">\n          <a href="${m(e)}"></a>\n        </blockquote>\n        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>\n      </div>\n    `:`\n      <div class="blockdoc-embed">\n        <iframe \n          src="${m(e)}" \n          frameborder="0" \n          width="100%" \n          height="400"\n          allowfullscreen>\n        </iframe>\n      </div>\n    `;if(r)return i+=`<figcaption class="blockdoc-caption">${m(r)}</figcaption>`,`<figure class="blockdoc-figure">${i}</figure>`;return i}(t);break;case"divider":o='<hr class="blockdoc-divider" />';break;default:o=`<p>Unknown block type: ${r}</p>`}return`${n}${o}${i}`}(t))})),e.push("</article>"),e.join("\n")}function g(t){if(!t||!t.blocks||!Array.isArray(t.blocks))throw new Error("Invalid article structure");const e=[`# ${t.title}`,""];if(t.metadata){if(t.metadata.author&&e.push(`> Author: ${t.metadata.author}`),t.metadata.publishedDate){const r=new Date(t.metadata.publishedDate);e.push(`> Published: ${r.toDateString()}`)}t.metadata.tags&&Array.isArray(t.metadata.tags)&&t.metadata.tags.length>0&&e.push(`> Tags: ${t.metadata.tags.join(", ")}`),e.push("")}return t.blocks.forEach((t=>{e.push(function(t){const{type:e}=t;switch(e){case"text":return function(t){return t.content}(t);case"heading":return function(t){const{level:e,content:r}=t,n=Math.min(Math.max(parseInt(e)||2,1),6);return`${"#".repeat(n)} ${r}`}(t);case"image":return function(t){const{url:e,alt:r,caption:n}=t;let i=`![${r||""}](${e})`;n&&(i+=`\n*${n}*`);return i}(t);case"code":return function(t){const{language:e,content:r}=t;return"```"+(e||"")+"\n"+r+"\n```"}(t);case"list":return function(t){const{items:e,listType:r}=t;if(!e||!Array.isArray(e))return"[Invalid list items]";return e.map(((t,e)=>"ordered"===r?`${e+1}. ${t}`:`- ${t}`)).join("\n")}(t);case"quote":return function(t){const{content:e,attribution:r}=t;let n=e.split("\n").map((t=>`> ${t}`)).join("\n");r&&(n+=`\n>\n>  ${r}`);return n}(t);case"embed":return function(t){const{url:e,caption:r,embedType:n}=t;let i=`[${n||"Embedded content"}: ${e}](${e})`;r&&(i+=`\n*${r}*`);return i}(t);case"divider":return"---";default:return`[Unknown block type: ${e}]`}}(t)),e.push("")})),e.join("\n")}c.marked.setOptions({highlight:function(t,e){return e&&a.getLanguage(e)?a.highlight(t,{language:e}).value:a.highlightAuto(t).value},headerIds:!0,mangle:!1});class y{constructor(t){let{title:e,metadata:r={},blocks:n=[]}=t;this.article={title:e,metadata:r,blocks:[]},n&&Array.isArray(n)&&n.forEach((t=>this.addBlock(t)))}validate(){const t=new e;r(t);const n=t.compile(k);if(!n({article:this.article})){const t=n.errors;throw new Error(`Invalid BlockDoc document: ${JSON.stringify(t)}`)}return!0}addBlock(t){if(this.getBlock(t.id))throw new Error(`Block with ID "${t.id}" already exists`);const e=new d(t);return this.article.blocks.push(e.toJSON()),e}insertBlock(t,e){if(this.getBlock(t.id))throw new Error(`Block with ID "${t.id}" already exists`);const r=new d(t);return this.article.blocks.splice(e,0,r.toJSON()),r}getBlock(t){return this.article.blocks.find((e=>e.id===t))||null}updateBlock(t,e){const r=this.article.blocks.findIndex((e=>e.id===t));if(-1===r)throw new Error(`Block with ID "${t}" not found`);const n={...this.article.blocks[r],...e},i=new d(n);return this.article.blocks[r]=i.toJSON(),this.article.blocks[r]}removeBlock(t){const e=this.article.blocks.findIndex((e=>e.id===t));return-1!==e&&(this.article.blocks.splice(e,1),!0)}moveBlock(t,e){const r=this.article.blocks.findIndex((e=>e.id===t));if(-1===r)return!1;if(e<0||e>=this.article.blocks.length)throw new Error(`Invalid position: ${e}`);const[n]=this.article.blocks.splice(r,1);return this.article.blocks.splice(e,0,n),!0}renderToHTML(){return b(this.article)}renderToMarkdown(){return g(this.article)}toJSON(){return{article:this.article}}toString(){return JSON.stringify(this.toJSON(),null,2)}static fromJSON(t){const e="string"==typeof t?JSON.parse(t):t;if(!e.article)throw new Error("Invalid BlockDoc document: missing article property");return new y({title:e.article.title,metadata:e.article.metadata||{},blocks:e.article.blocks||[]})}}t.Block=d,t.BlockDocDocument=y,t.renderToHTML=b,t.renderToMarkdown=g,t.schema=k,t.version="1.0.0"}));
//# sourceMappingURL=blockdoc.min.js.map
